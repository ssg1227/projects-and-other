<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tracker App with ML</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js"></script>
  <style>
    .screen { display: none; }
    .visible { display: block; }
    label { display: block; margin-top: 8px; }
    button { margin: 4px 4px 8px 0; }
    textarea { width: 100%; height: 100px; }
    nav button { margin-right: 8px; }
  </style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth-screen" class="screen visible">
  <h2>Welcome</h2>
  <button onclick="showRegister()">Register</button>
  <button onclick="showProfile()">Login (Skip password)</button>
</div>

<!-- REGISTER SCREEN -->
<div id="register-screen" class="screen">
  <h2>Register Profile</h2>
  <form id="registerForm">
    <label>User ID: <input type="text" name="userId" required /></label>
    <label>Name: <input type="text" name="name" required /></label>
    <label>DOB: <input type="date" name="dob" required /></label>
    <label>Gender:
      <select name="gender" required>
        <option value="">Select</option>
        <option value="female">Female</option>
        <option value="male">Male</option>
        <option value="other">Other</option>
      </select>
    </label>
    <label>Religion:
      <select name="religion" required>
        <option value="">Select</option>
        <option value="hindu">Hindu</option>
        <option value="other">Other</option>
      </select>
    </label>
    <label>Deities (comma-separated, ordered): <input type="text" name="deities" /></label>
    <label>Other Interests (comma-separated): <input type="text" name="interests" /></label>
    <button type="submit">Save & Proceed</button>
  </form>
  <p id="registerStatus"></p>
</div>

<!-- PROFILE/APP SCREEN -->
<div id="profile-screen" class="screen">
  <h2>Dashboard</h2>
  <nav>
    <button onclick="showTab('learn')">Learn</button>
    <button onclick="showTab('predict')">Predict</button>
    <button onclick="showAuth()">Logout</button>
  </nav>

  <div id="learn-tab" class="tab">
    <h3>Learn (Paste URLs)</h3>
    <textarea id="urlInput" placeholder="Paste one URL per line..."></textarea>
    <button onclick="learnUrls()">Add to History</button>
    <p id="learnStatus"></p>
  </div>
<!-- Predict Tab -->
<div id="predict-tab" class="tab" style="display:none;">
  <h3>Predict</h3>
  <p>Total URLs stored: <span id="urlCount">0</span></p>
  <button onclick="toggleHistory()">Show/Hide History</button>
  <button onclick="clearHistory()">Clear History</button>
  <div id="historyContainer" style="display:none; max-height:200px; overflow:auto; border:1px solid #ccc; padding:8px; margin-top:8px;">
    <!-- History entries inserted here -->
  </div>
  <button onclick="runPrediction()">Predict Next URL</button>
  <p id="predictionResult"></p>
</div>

</div>

<script>
  // ----- Screens -----
  const screens = {
    auth: document.getElementById('auth-screen'),
    register: document.getElementById('register-screen'),
    profile: document.getElementById('profile-screen')
  };
  function switchScreen(id) {
    Object.values(screens).forEach(s => s.classList.remove('visible'));
    screens[id].classList.add('visible');
  }
function toggleHistory() {
  const container = document.getElementById('historyContainer');
  if (!container) return;

  if (container.style.display === 'none' || container.style.display === '') {
    // Show and fill
    const history = JSON.parse(localStorage.getItem('visitHistory')) || [];
    container.innerHTML = ''; // Clear old

    if (history.length === 0) {
      container.textContent = 'No history yet.';
    } else {
      history.forEach((entry, i) => {
        const date = new Date(entry.timestamp);
        const div = document.createElement('div');
        div.textContent = `${i + 1}. ${entry.url} — ${date.toLocaleString()}`;
        container.appendChild(div);
      });
    }

    container.style.display = 'block';
  } else {
    // Hide
    container.style.display = 'none';
  }
}

  function showRegister() { switchScreen('register'); }
  function showProfile() {
    const profile = JSON.parse(localStorage.getItem('userProfile'));
    if (!profile || !profile.userId) return alert("No profile found");
    switchScreen('profile');
    showTab('learn');
  }
  function showAuth() { switchScreen('auth'); }

  // ----- Tabs -----
  function showTab(tab) {
    document.getElementById('learn-tab').style.display = (tab === 'learn') ? 'block' : 'none';
    document.getElementById('predict-tab').style.display = (tab === 'predict') ? 'block' : 'none';
  }

  // ----- Register -----
  document.getElementById('registerForm').addEventListener('submit', e => {
    e.preventDefault();
    const data = new FormData(e.target);
    const profile = {};
    data.forEach((val, key) => profile[key] = val.trim());
    profile.deities = profile.deities ? profile.deities.split(',').map(s => s.trim()) : [];
    profile.interests = profile.interests ? profile.interests.split(',').map(s => s.trim()) : [];
    localStorage.setItem('userProfile', JSON.stringify(profile));
    document.getElementById('registerStatus').textContent = "Profile saved ✅";
    showProfile();
  });

  // ----- Learn Tab -----
  function learnUrls() {
    const textarea = document.getElementById('urlInput');
    const urls = textarea.value.trim().split('\n').map(s => s.trim()).filter(Boolean);
    if (urls.length === 0) return;

    const history = JSON.parse(localStorage.getItem('visitHistory')) || [];
    const profile = JSON.parse(localStorage.getItem('userProfile'));
    const now = new Date();

    urls.forEach(url => {
      history.push({
        userId: profile.userId,
        url,
        timestamp: new Date().toISOString(),
        user: {
          religion: profile.religion,
          deities: profile.deities,
          interests: profile.interests
        }
      });
    });

    localStorage.setItem('visitHistory', JSON.stringify(history));
    document.getElementById('learnStatus').textContent = `${urls.length} URLs added ✅`;
    textarea.value = '';
  }

  // ----- Predict Tab -----
  async function runPrediction() {
    const history = JSON.parse(localStorage.getItem('visitHistory')) || [];
    if (history.length < 50) {
      document.getElementById('predictionResult').textContent = "Need at least 50 entries to predict.";
      return;
    }

    const urls = history.map(h => h.url);
    const urlSet = [...new Set(urls)];
    const urlToIndex = Object.fromEntries(urlSet.map((url, i) => [url, i]));
    const indexToUrl = urlSet;

    const inputSequences = [];
    const outputLabels = [];

    for (let i = 0; i < urls.length - 1; i++) {
      inputSequences.push(urlToIndex[urls[i]]);
      outputLabels.push(urlToIndex[urls[i + 1]]);
    }

    const xs = tf.tensor2d(inputSequences.map(i => [i]));
    const ys = tf.oneHot(outputLabels, urlSet.length);

    const model = tf.sequential();
    model.add(tf.layers.dense({ units: 16, activation: 'relu', inputShape: [1] }));
    model.add(tf.layers.dense({ units: urlSet.length, activation: 'softmax' }));

    model.compile({ loss: 'categoricalCrossentropy', optimizer: 'adam', metrics: ['accuracy'] });

    await model.fit(xs, ys, { epochs: 20, verbose: 0 });

    const last = urls[urls.length - 1];
    const lastIndex = tf.tensor2d([[urlToIndex[last]]]);
    const prediction = model.predict(lastIndex);
    const predictedIndex = prediction.argMax(1).dataSync()[0];
    const nextUrl = indexToUrl[predictedIndex];

    document.getElementById('predictionResult').textContent =
      `Based on your last visit (${last}), you might go to → ${nextUrl}`;
  }
</script>

</body>
</html>
